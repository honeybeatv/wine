<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="WineXml">

	<!-- 와인 총 갯수 -->
	<select id="listCount" resultType="int">
		select count(wine_no)
		from wine
		where wine_no > 0
	</select>

	<!-- 검색한 와인 갯수 -->
	<select id="listCountBySearch" resultType="int"
		parameterType="com.javaex.vo.WineVo">
		<![CDATA[
		select count(w.wine_no)	   
      	from (
        	select row_number() over (order by e.wine_no desc) as num, 
        		   e.*
         	from wine e
         ]]>
		<if test="keyword != null and keyword != '' ">
			<![CDATA[
         	where (
					   e.wine_type like '%' || #{keyword} || '%' 
					or e.wine_name like '%' || #{keyword} || '%' 
					or e.wine_country like '%' || #{keyword} || '%'
				)
			]]>
		</if>
		<![CDATA[
      	) w, wine_description d
      	where num >= #{rowStart} and num <= #{rowEnd}
      	and w.wine_no = d.wine_no(+)
      	order by num desc
		]]>
	</select>

	<!-- 타입별 와인 갯수 -->
	<select id="listCountByType" resultType="int"
		parameterType="String">
		<![CDATA[
		select count(w.wine_no)	   
      	from (
        	select row_number() over (order by e.wine_no desc) as num, 
        		   e.*
         	from wine e
      	) w, wine_description d
      	where w.wine_no = d.wine_no(+)
      	and num >= #{rowStart} and num <= #{rowEnd}
      	and w.wine_type = #{wine_type}
      	order by w.wine_no desc
		]]>
	</select>

	<!-- 와인리스트 불러오기 -->
	<select id="listPage" resultType="com.javaex.vo.WineVo"
		parameterType="com.javaex.vo.WineVo">
	<![CDATA[
		select w.wine_no, 
			   w.wine_name,
			   w.wine_type, 
			   w.wine_country, 
			   w.reg_date, 
			   d.wine_price, 
			   d.wine_stock,
			   d.wine_image		   
      	from (
        	select row_number() over (order by e.wine_no desc) as num, 
        		   e.*
         	from wine e
      	) w, wine_description d
      	where num >= #{rowStart} and num <= #{rowEnd}
      	and w.wine_no = d.wine_no(+)
		]]>
	</select>

	<!-- 와인리스트 검색 -->
	<select id="searchByKeyword" resultType="com.javaex.vo.WineVo"
		parameterType="com.javaex.vo.WineVo">
		<![CDATA[
			select w.wine_no, 
			       w.wine_name,
			       w.wine_type, 
			       w.wine_country, 
			       w.reg_date,
			       w.wine_price, 
			       w.wine_stock,
			       w.wine_image
			from (
			    select row_number() over (order by b.wine_no desc) as num, 
			           b.*,
			           r.wine_price,
			           r.wine_stock,
			           r.wine_image
			    from wine b, wine_description r
			    where 1=1
			    and b.wine_no = r.wine_no 
		]]>
		<if test="keyword != null and keyword != '' ">
			<![CDATA[
         	and (
					   b.wine_type like '%' || #{keyword} || '%' 
					or b.wine_name like '%' || #{keyword} || '%' 
					or b.wine_country like '%' || #{keyword} || '%'
				)
			]]>
		</if>
		<![CDATA[
			) w
			where num >= #{rowStart} and num <= #{rowEnd}
		]]>

	</select>

	<!-- 타입별 와인리스트 -->
	<select id="listCateByType" resultType="com.javaex.vo.WineVo"
		parameterType="com.javaex.vo.WineVo">
		<![CDATA[
			select w.wine_no, 
				   w.wine_name,
				   w.wine_type, 
				   w.wine_country, 
				   w.reg_date, 
				   d.wine_price, 
				   d.wine_stock,
				   d.wine_image
			from wine w, wine_description d 
			where w.wine_no = d.wine_no(+)
		]]>

		<if test="wine_type=='레드'">
			AND w.wine_type = '레드'
		</if>
		<if test="wine_type=='화이트'">
			AND w.wine_type = '화이트'
		</if>
		<if test="wine_type=='로제'">
			AND w.wine_type = '로제'
		</if>
		
		<![CDATA[
			order by w.wine_no desc
		]]>

	</select>

	<!-- 와인리스트 정렬 -->
	<select id="sortByWinelist" resultType="com.javaex.vo.WineVo"
		parameterType="com.javaex.vo.WineVo">
		<![CDATA[
			select w.wine_no, 
			       w.wine_name,
			       w.wine_type, 
			       w.wine_country, 
			       w.reg_date,
			       w.wine_price, 
			       w.wine_stock,
			       w.wine_image
			from (
		]]>
		<choose>
			<when test="sort_type=='wine_name_up'">
				<![CDATA[
				select row_number() over (order by b.wine_name) as num,
				]]>
			</when>
			<when test="sort_type=='wine_name_down'">
				<![CDATA[
				select row_number() over (order by b.wine_name desc) as num,
				]]>
			</when>
			<when test="sort_type=='wine_price_up'">
				<![CDATA[
				select row_number() over (order by r.wine_price) as num,
				]]>
			</when>
			<when test="sort_type=='wine_price_down'">
				<![CDATA[
				select row_number() over (order by r.wine_price desc) as num,
				]]>
			</when>
			<when test="sort_type=='reg_date_up'">
				<![CDATA[
				select row_number() over (order by b.reg_date) as num,
				]]>
			</when>
			<when test="sort_type=='reg_date_down'">
				<![CDATA[
				select row_number() over (order by b.reg_date desc) as num,
				]]>
			</when>
		</choose>
		<![CDATA[
					b.*,
			        r.wine_price,
			        r.wine_stock,
			        r.wine_image
			    from wine b, wine_description r
			    where 1=1
			    and b.wine_no = r.wine_no 
			) w
			where num >= #{rowStart} and num <= #{rowEnd}
		]]>
		

	</select>

	<!-- 와인 추가 -->
	<insert id="insert" parameterType="com.javaex.vo.WineVo">
		<![CDATA[	
			INSERT ALL
			INTO wine VALUES(seq_wine_no.nextval, #{wine_name}, #{wine_type}, #{wine_country}, sysdate)
			INTO wine_Description VALUES(seq_wine_no.nextval, #{wine_company}, #{wine_alcohol}, #{wine_price}, #{wine_stock}, #{wine_image}, #{wine_description})
			SELECT * FROM DUAL	
		]]>
	</insert>

	<!-- 와인 삭제 -->
	<delete id="delete" parameterType="int">
		DELETE FROM WINE_DESCRIPTION WHERE WINE_NO = #{wine_no);
		DELETE FROM WINE WHERE WINE_NO = #{wine_no);
	</delete>

	<!-- 상세정보 가져오기 -->
	<select resultType="com.javaex.vo.WineVo" parameterType="int"
		id="selectById">

		<![CDATA[
		select d.wine_no, 
			   w.wine_name, 
			   d.wine_company, 
			   d.wine_price, 
    		   d.wine_stock, 
    		   d.wine_image, 
    		   d.wine_alcohol, 
    		   w.wine_country, 
    		   d.wine_description,
    		   w.wine_country, 
    		   w.wine_type
    	from WINE_DESCRIPTION d, WINE w
    	where d.wine_no = w.wine_no
    	and w.wine_no = #{wine_no}
		]]>
	</select>
</mapper>
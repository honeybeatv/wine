<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="WineXml">

	<!-- 와인 총 갯수 -->
	<select id="listCount" resultType="int">
		select count(wine_no)
		from wine
		where wine_no > 0
	</select>

	<!-- 검색한 와인 갯수 -->
	<select id="listCountBySearch" resultType="int"
		parameterType="com.javaex.vo.WineVo">
		<![CDATA[
		select count(w.wine_no)
		from wine w, wine_description d
		where w.wine_no = d.wine_no(+)
		and (
       		w.wine_type like '%' || #{keyword} || '%' 		or
			w.wine_name like '%' || #{keyword} || '%' 		or
			w.wine_country like '%' || #{keyword} || '%'
		)
		]]>
	</select>

	<!-- 타입별 와인 갯수 -->
	<select id="listCountByType" resultType="int"
		parameterType="com.javaex.vo.WineVo">
		<![CDATA[
		select count(w.wine_no)	   
      	from wine w, wine_description d
      	where w.wine_no = d.wine_no(+)
      	and w.wine_type = #{wine_type}
		]]>
	</select>

	<!-- 와인리스트 불러오기 (정렬기능) -->
	<select id="listPage" resultType="com.javaex.vo.WineVo"
		parameterType="com.javaex.vo.WineVo">
	<![CDATA[
			select w.wine_no, 
			       w.wine_name,
			       w.wine_type, 
			       w.wine_country, 
			       w.reg_date,
			       w.wine_price, 
			       w.wine_stock,
			       w.wine_image
			from (
		]]>
		<choose>
			<when test="sort_type=='wine_name_up'">		<!-- 가나다순 -->
				<![CDATA[
				select row_number() over (order by b.wine_name) as num,
				]]>
			</when>
			<when test="sort_type=='wine_name_down'">	<!-- 가나다역순 -->
				<![CDATA[
				select row_number() over (order by b.wine_name desc) as num,
				]]>
			</when>
			<when test="sort_type=='wine_price_up'">	<!-- 낮은가격순 -->
				<![CDATA[
				select row_number() over (order by r.wine_price) as num,
				]]>
			</when>
			<when test="sort_type=='wine_price_down'">	<!-- 높은가격순 -->
				<![CDATA[
				select row_number() over (order by r.wine_price desc) as num,
				]]>
			</when>
			<when test="sort_type=='reg_date_up'">		<!-- 등록일순 -->
				<![CDATA[
				select row_number() over (order by b.reg_date) as num,
				]]>
			</when>
			<when test="sort_type=='reg_date_down'">	<!-- 최신순 -->
				<![CDATA[
				select row_number() over (order by b.reg_date desc) as num,
				]]>
			</when>
		</choose>
		<![CDATA[
					b.*,
			        r.wine_price,
			        r.wine_stock,
			        r.wine_image
			    from wine b, wine_description r
			    where 1=1
			    and b.wine_no = r.wine_no 
			) w
			where num >= #{rowStart} and num <= #{rowEnd}
		]]>
	</select>

	<!-- 와인리스트 검색 -->
	<select id="searchByKeyword" resultType="com.javaex.vo.WineVo"
		parameterType="com.javaex.vo.WineVo">
		<![CDATA[
			select w.wine_no, 
			       w.wine_name,
			       w.wine_type, 
			       w.wine_country, 
			       w.reg_date,
			       w.wine_price, 
			       w.wine_stock,
			       w.wine_image
			from (
			    select row_number() over (order by b.wine_no desc) as num, 
			           b.*,
			           r.wine_price,
			           r.wine_stock,
			           r.wine_image
			    from wine b, wine_description r
			    where b.wine_no = r.wine_no 
		]]>
		<if test="keyword != null and keyword != '' ">
			<![CDATA[
         		and (
         			b.wine_type like '%' || #{keyword} || '%' or
         			b.wine_name like '%' || #{keyword} || '%' or
         			b.wine_country like '%' || #{keyword} || '%'
         		)
			]]>
		</if>
		<![CDATA[
			) w
			where num >= #{rowStart} and num <= #{rowEnd}
		]]>

	</select>

	<!-- 타입별 와인리스트 -->
	<select id="listCateByType" resultType="com.javaex.vo.WineVo"
		parameterType="com.javaex.vo.WineVo">
		<![CDATA[
			select w.wine_no, 
			       w.wine_name,
			       w.wine_type, 
			       w.wine_country, 
			       w.reg_date,
			       w.wine_price, 
			       w.wine_stock,
			       w.wine_image
			from (
			    select row_number() over (order by b.wine_no desc) as num, 
			           b.*,
			           r.wine_price,
			           r.wine_stock,
			           r.wine_image
			    from wine b, wine_description r
			    where b.wine_no = r.wine_no 
		]]>
		<if test="keyword == null or keyword == '' ">
			<![CDATA[
         		and b.wine_type = #{wine_type}
			]]>
		</if>
		<![CDATA[
			) w
			where num >= #{rowStart} and num <= #{rowEnd}
		]]>

	</select>

	<!-- 와인 추가 -->
	<insert id="insert" parameterType="com.javaex.vo.WineVo">
		<![CDATA[	
			INSERT ALL
			INTO wine VALUES(seq_wine_no.nextval, #{wine_name}, #{wine_type}, #{wine_country}, sysdate)
			INTO wine_Description VALUES(seq_wine_no.nextval, #{wine_company}, #{wine_alcohol}, #{wine_price}, #{wine_stock}, #{wine_image}, #{wine_description})
			SELECT * FROM DUAL	
		]]>
	</insert>

	<!-- 와인 삭제 -->

	<delete id="delete" parameterType="com.javaex.vo.WineVo">
		<![CDATA[
		begin
		DELETE FROM WINE_DESCRIPTION WHERE WINE_NO = #{wine_no};
		DELETE FROM WINE WHERE WINE_NO = #{wine_no};
		end;
		]]>
	</delete>

	<!-- 상세정보 가져오기 -->
	<select resultType="com.javaex.vo.WineVo" parameterType="int"
		id="selectById">

		<![CDATA[
		select d.wine_no, 
			   w.wine_name, 
			   d.wine_company, 
			   d.wine_price, 
    		   d.wine_stock, 
    		   d.wine_image, 
    		   d.wine_alcohol, 
    		   w.wine_country, 
    		   d.wine_description,
    		   w.wine_country, 
    		   w.wine_type
    	from WINE_DESCRIPTION d, WINE w
    	where d.wine_no = w.wine_no
    	and w.wine_no = #{wine_no}
		]]>
	</select>
</mapper>